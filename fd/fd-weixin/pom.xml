<?xml version="1.0"?>
<project
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
	xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<modelVersion>4.0.0</modelVersion>

	<parent>
		<groupId>com.fd</groupId>
		<artifactId>fd</artifactId>
		<version>1.0.0</version>
	</parent>

	<artifactId>fd-weixin</artifactId>
	<name>fd-weixin</name>
	<packaging>war</packaging>

	<properties>
		<commons-fileupload.version>1.3.1</commons-fileupload.version>
		<urlrewritefilter.version>4.0.4</urlrewritefilter.version>
		<javaee-api.version>7.0</javaee-api.version>
		<jstl.version>1.2</jstl.version>
		<junit.version>4.12</junit.version>
		<spring.version>4.2.0.RELEASE</spring.version>
		<servlet.version>3.1.0</servlet.version>
		<project.build.frontend.version>1.2</project.build.frontend.version>
    	<project.build.node.version>v0.10.40</project.build.node.version>
    	<project.build.npm.version>1.4.12</project.build.npm.version>
    	<!-- 配置项目编码为UTF-8 -->
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<buildtimestamp>${timestamp}</buildtimestamp>
	</properties>

	<dependencies>
		<dependency>    
           <groupId>com.fd</groupId>
		   <artifactId>fd-core</artifactId>
		   <version>${project.version}</version> 
           <exclusions>    
                  <exclusion>    
                         <groupId>com.fd</groupId>    
                         <artifactId>fd-tools</artifactId>    
                  </exclusion>    
           </exclusions>    
	    </dependency>
	  	<dependency>
			<groupId>com.fd</groupId>
			<artifactId>fd-tools</artifactId>
			<version>${project.version}</version>
		</dependency>
		<dependency>
			<groupId>junit</groupId>
			<artifactId>junit</artifactId>
			<version>${junit.version}</version>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework</groupId>
			<artifactId>spring-test</artifactId>
			<version>${spring.version}</version>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>commons-fileupload</groupId>
			<artifactId>commons-fileupload</artifactId>
			<version>${commons-fileupload.version}</version>
		</dependency>
		<!-- urlrewrite伪静态 -->
		<dependency>
			<groupId>org.tuckey</groupId>
			<artifactId>urlrewritefilter</artifactId>
			<version>${urlrewritefilter.version}</version>
		</dependency>
		<!-- J2EE -->
		<dependency>
			<groupId>javax</groupId>
			<artifactId>javaee-api</artifactId>
			<version>${javaee-api.version}</version>
		</dependency>
		<dependency>
			<groupId>jstl</groupId>
			<artifactId>jstl</artifactId>
			<version>${jstl.version}</version>
		</dependency>
		<dependency>
			<groupId>javax.servlet</groupId>
			<artifactId>javax.servlet-api</artifactId>
			<version>${servlet.version}</version>
		</dependency>
	</dependencies>


	<build>
		<finalName>fd-weixin</finalName>
		<plugins>  
    		<plugin>  
		        <groupId>org.apache.maven.plugins</groupId>  
		        <artifactId>maven-compiler-plugin</artifactId>  
		        <version>2.3.2</version>  
		        <configuration>  
		            <source>1.7</source>  
		            <target>1.7</target>  
		        </configuration>  
		    </plugin> 
		    <plugin>
	           <groupId>org.codehaus.mojo</groupId>
	           <artifactId>buildnumber-maven-plugin</artifactId>
	           <version>1.3</version>
	           <executions>
	               <execution>
	                   <phase>validate</phase>
	                   <goals>
	                       <goal>create-timestamp</goal>
	                   </goals>
	               </execution>
	           </executions>
	           <configuration>
	               <format>{0,date,yyyy-MM-dd HH:mm:ss}</format>
	               <items>
	                   <item>timestamp</item>
	               </items>
	           </configuration>
	       </plugin>
	       <plugin>
				<groupId>com.google.code.maven-replacer-plugin</groupId>
				<artifactId>replacer</artifactId>
				<version>1.5.2</version>
				<executions>
					<execution>
						<phase>prepare-package</phase>
						<goals>
							<goal>replace</goal>
						</goals>
					</execution>
				</executions>
				<configuration>
					<!-- 读取js,css文件采用UTF-8编码 -->
					<encoding>${project.build.sourceEncoding}</encoding>
					<!-- 需要替换的jsp文件的目录 -->
					<basedir>${basedir}/src/main/webapp/WEB-INF/view</basedir>  
				    <includes>  
				        <include>**/*.jsp</include>  
				    </includes>  
				    <!-- 新生成的jsp文件存放的路径 -->
				    <outputBasedir>${project.build.directory}/${project.build.finalName}/WEB-INF/view</outputBasedir>  
				    <outputDir>.</outputDir>  
					<replacements>
						<replacement>
							<token>
		                  <![CDATA[
		                  <!--# mergeTo:([^\s]*) -->(.*?)<!--# mergeTo -->
		                  ]]>
							</token>
							<value>
		                  <![CDATA[
		                  <script src="$1?v=${timestamp}"></script>
		                  ]]>
							</value>
						</replacement>
					</replacements>
					<regexFlags>
						<regexFlag>CASE_INSENSITIVE</regexFlag>
						<regexFlag>DOTALL</regexFlag>
					</regexFlags>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-war-plugin</artifactId>
				<version>2.4</version>
				<configuration>
					<!-- 打包前已经通过工具生成了，打包时不能再打包 -->
					<warSourceExcludes>WEB-INF/view/,static/css/**/*.css.map</warSourceExcludes>
				</configuration>
			</plugin>
	       
	       <plugin>
	           <groupId>com.github.eirslett</groupId>
	           <artifactId>frontend-maven-plugin</artifactId>
	           <version>${project.build.frontend.version}</version>
	           <executions>
	               <execution>
	                   <id>install node and npm</id>
	                   <goals>
	                       <goal>install-node-and-npm</goal>
	                   </goals>
	                   <phase>generate-resources</phase>
	                   <configuration>
	                   	   <nodeVersion>${project.build.node.version}</nodeVersion>
	                       <npmVersion>${project.build.npm.version}</npmVersion>
	                   </configuration>
	               </execution>
	               <execution>
	                   <id>npm install</id>
	                   <phase>generate-resources</phase>
	                   <goals>
	                       <goal>npm</goal>
	                   </goals>
	                   <configuration>
	                       <arguments>install</arguments>
	                   </configuration>
	               </execution>
	               <execution>
	                   <id>gulp build</id>
	                   <phase>generate-resources</phase>
	                   <goals>
	                       <goal>gulp</goal>
	                   </goals>
	                   <configuration>
	                       <arguments>${gulp.build}</arguments>
	                   </configuration>
	               </execution>
	           </executions>
	       </plugin> 
		</plugins>
		<resources>
			<resource>
				<directory>src/main/java</directory>
				<includes>
					<include>**/*.xml</include>
				</includes>
				<!-- 是否替换资源中的属性 -->
				<filtering>false</filtering>
			</resource>
			<resource>
				<directory>src/main/resources</directory>
				<filtering>true</filtering>
				<includes>
					<include>*</include>
				</includes>
			</resource>
			<resource>
				<directory>src/main/resources/${env}</directory>
				<filtering>true</filtering>
			</resource>
		</resources>
		<pluginManagement>
	    	<plugins>
	    		<!--This plugin's configuration is used to store Eclipse m2e settings only. It has no influence on the Maven build itself.-->
	    		<plugin>
	    			<groupId>org.eclipse.m2e</groupId>
	    			<artifactId>lifecycle-mapping</artifactId>
	    			<version>1.0.0</version>
	    			<configuration>
	    				<lifecycleMappingMetadata>
	    					<pluginExecutions>
	    						<pluginExecution>
	    							<pluginExecutionFilter>
	    								<groupId>org.codehaus.mojo</groupId>
	    								<artifactId>
	    									buildnumber-maven-plugin
	    								</artifactId>
	    								<versionRange>[1.3,)</versionRange>
	    								<goals>
	    									<goal>create-timestamp</goal>
	    								</goals>
	    							</pluginExecutionFilter>
	    							<action>
	    								<ignore></ignore>
	    							</action>
	    						</pluginExecution>
	    					</pluginExecutions>
	    				</lifecycleMappingMetadata>
	    			</configuration>
	    		</plugin>
	    	</plugins>
	    </pluginManagement>
	</build>

	<profiles>
		<profile>
			<id>test</id>
			<activation>
				<activeByDefault>true</activeByDefault>
			</activation>
			<properties>
				<env>test</env>
			</properties>
		</profile>
		<profile>
			<id>production</id>
			<properties>
				<env>production</env>
			</properties>
		</profile>
	</profiles>
</project>
